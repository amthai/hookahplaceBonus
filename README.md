# HookahPlace Bonus - Telegram Mini App

Программа лояльности для заведения с механикой отметок посещений и бонусной системой.

## Функционал

- ✅ Отметка посещений через сканирование QR кода
- ✅ Прогресс-бар до следующего бонуса (10 посещений = 1 бонус)
- ✅ История посещений и бонусов
- ✅ Адаптивный дизайн для Telegram Mini App
- ✅ База данных SQLite для хранения данных

## Установка и запуск

### 1. Установка зависимостей

```bash
npm install
```

### 2. Настройка конфигурации

Создайте файл `.env` в корне проекта:

```env
PORT=3000
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_WEBAPP_URL=https://your-domain.com
DATABASE_PATH=./database.sqlite
```

### 3. Запуск сервера

```bash
# Разработка
npm run dev

# Продакшн
npm start
```

### 4. Настройка Telegram Bot

1. Создайте бота через @BotFather в Telegram
2. Получите токен бота
3. Установите Web App URL: `https://your-domain.com`
4. Добавьте токен в `.env` файл

## API Endpoints

### Пользователи
- `GET /api/user/:telegramId` - Получить данные пользователя
- `POST /api/user` - Создать/обновить пользователя

### Посещения
- `POST /api/visit` - Отметить посещение
- `GET /api/visits/:userId` - История посещений

### Бонусы
- `GET /api/bonuses/:userId` - Получить бонусы пользователя
- `POST /api/bonus/use/:bonusId` - Использовать бонус

### QR код
- `GET /api/qr-code` - Получить QR код для заведения

## Механика работы

1. **Отметка посещения**: Пользователь сканирует QR код в заведении
2. **Прогресс**: Каждое посещение засчитывается
3. **Бонус**: При достижении 10 посещений пользователь получает бонус
4. **Ограничения**: Один раз в день на пользователя

## QR код для заведения

QR код содержит данные: `HOOKAH_PLACE_QR`

Для получения QR кода перейдите по адресу: `http://localhost:3000/api/qr-code`

## Структура базы данных

### Таблица users
- `id` - ID пользователя
- `telegram_id` - Telegram ID
- `username` - Имя пользователя
- `first_name` - Имя
- `last_name` - Фамилия
- `created_at` - Дата создания

### Таблица visits
- `id` - ID посещения
- `user_id` - ID пользователя
- `visit_date` - Дата посещения
- `qr_code` - QR код

### Таблица bonuses
- `id` - ID бонуса
- `user_id` - ID пользователя
- `bonus_type` - Тип бонуса
- `earned_date` - Дата получения
- `used_date` - Дата использования
- `is_used` - Использован ли бонус

## Развертывание

### Heroku
1. Создайте приложение на Heroku
2. Добавьте переменные окружения
3. Подключите GitHub репозиторий
4. Включите автоматическое развертывание

### VPS
1. Установите Node.js и npm
2. Клонируйте репозиторий
3. Установите зависимости
4. Настройте nginx как прокси
5. Запустите через PM2

## Безопасность

- Валидация QR кодов
- Проверка на дублирование посещений в день
- Защита от SQL инъекций через параметризованные запросы
- CORS настройки для безопасности

## Разработка

Для разработки используйте:

```bash
npm run dev
```

Сервер будет перезапускаться автоматически при изменении файлов.
