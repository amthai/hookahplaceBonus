<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HookahPlace Bonus</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
            margin-bottom: 10px;
        }

        .user-info {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 4px;
        }

        .progress-bar {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--tg-theme-button-color, #2481cc);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .bonus-info {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .bonus-text {
            font-size: 16px;
            font-weight: 600;
        }

        .scan-button {
            width: 100%;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: opacity 0.2s;
        }

        .scan-button:hover {
            opacity: 0.9;
        }

        .scan-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history-section {
            margin-top: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .visit-item {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .visit-date {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .bonus-item {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bonus-type {
            font-weight: 600;
        }

        .bonus-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: #4ecdc4;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üö¨ HookahPlace</div>
            <div>–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
        </div>

        <div id="userInfo" class="user-info">
            <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="visitCount">0</div>
                    <div class="stat-label">–ü–æ—Å–µ—â–µ–Ω–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="bonusCount">0</div>
                    <div class="stat-label">–ë–æ–Ω—É—Å–æ–≤</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div id="progressText" style="text-align: center; font-size: 14px; color: var(--tg-theme-hint-color, #999999);">
                –î–æ –±–æ–Ω—É—Å–∞: 10 –ø–æ—Å–µ—â–µ–Ω–∏–π
            </div>
        </div>

        <div id="bonusInfo" class="bonus-info" style="display: none;">
            <div class="bonus-text">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å!</div>
        </div>

        <button id="scanButton" class="scan-button">
            üì± –û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ
        </button>

        <div class="history-section">
            <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π</div>
            <div id="visitHistory"></div>
        </div>

        <div class="history-section">
            <div class="section-title">–ú–æ–∏ –±–æ–Ω—É—Å—ã</div>
            <div id="bonusHistory"></div>
        </div>
    </div>

    <script>
        // Telegram WebApp API
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        let currentUser = null;
        let visitHistory = [];
        let bonusHistory = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            try {
                console.log('Initializing app...');
                console.log('Telegram initData:', tg.initData);
                console.log('Telegram initDataUnsafe:', tg.initDataUnsafe);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                const user = tg.initDataUnsafe?.user;
                console.log('Telegram user:', user);
                
                if (!user) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    console.log('No user data from Telegram, creating test user');
                    const testUser = {
                        id: 123456789,
                        username: 'testuser',
                        first_name: 'Test',
                        last_name: 'User'
                    };
                    await createUser(testUser);
                } else {
                    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await createUser(user);
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserData();
                await loadVisitHistory();
                await loadBonusHistory();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function createUser(telegramUser) {
            console.log('Creating user:', telegramUser);
            try {
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: telegramUser.id,
                        username: telegramUser.username || 'unknown',
                        first_name: telegramUser.first_name || 'User',
                        last_name: telegramUser.last_name || ''
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + (errorData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }

                const result = await response.json();
                currentUser = { id: result.user_id, ...telegramUser };
                console.log('User created:', currentUser);
            } catch (error) {
                console.error('Error creating user:', error);
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            if (!currentUser) {
                console.error('currentUser is null');
                return;
            }
            
            const response = await fetch(`/api/user/${currentUser.id}`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }

            const data = await response.json();
            currentUser = { ...currentUser, ...data.user };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('userName').textContent = 
                `${data.user.first_name} ${data.user.last_name || ''}`.trim();
            
            document.getElementById('visitCount').textContent = data.visits;
            document.getElementById('bonusCount').textContent = data.bonuses;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
            const progress = ((data.visits % 10) / 10) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = 
                `–î–æ –±–æ–Ω—É—Å–∞: ${data.visits_to_bonus} –ø–æ—Å–µ—â–µ–Ω–∏–π`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
        async function loadVisitHistory() {
            if (!currentUser) {
                console.error('currentUser is null');
                return;
            }
            
            const response = await fetch(`/api/visits/${currentUser.id}`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π');
            }

            visitHistory = await response.json();
            renderVisitHistory();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤
        async function loadBonusHistory() {
            if (!currentUser) {
                console.error('currentUser is null');
                return;
            }
            
            const response = await fetch(`/api/bonuses/${currentUser.id}`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤');
            }

            bonusHistory = await response.json();
            renderBonusHistory();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
        function renderVisitHistory() {
            const container = document.getElementById('visitHistory');
            container.innerHTML = '';

            if (visitHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--tg-theme-hint-color, #999999); padding: 20px;">–ù–µ—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π</div>';
                return;
            }

            visitHistory.forEach(visit => {
                const visitElement = document.createElement('div');
                visitElement.className = 'visit-item';
                visitElement.innerHTML = `
                    <div>–ü–æ—Å–µ—â–µ–Ω–∏–µ #${visit.id}</div>
                    <div class="visit-date">${formatDate(visit.visit_date)}</div>
                `;
                container.appendChild(visitElement);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤
        function renderBonusHistory() {
            const container = document.getElementById('bonusHistory');
            container.innerHTML = '';

            if (bonusHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--tg-theme-hint-color, #999999); padding: 20px;">–ù–µ—Ç –±–æ–Ω—É—Å–æ–≤</div>';
                return;
            }

            bonusHistory.forEach(bonus => {
                const bonusElement = document.createElement('div');
                bonusElement.className = 'bonus-item';
                bonusElement.innerHTML = `
                    <div>
                        <div class="bonus-type">${getBonusTypeText(bonus.bonus_type)}</div>
                        <div class="bonus-status">${formatDate(bonus.earned_date)}</div>
                    </div>
                    <div>
                        ${bonus.is_used ? '‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : '‚è≥ –î–æ—Å—Ç—É–ø–µ–Ω'}
                    </div>
                `;
                container.appendChild(bonusElement);
            });
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ç–∏–ø–∞ –±–æ–Ω—É—Å–∞
        function getBonusTypeText(type) {
            switch (type) {
                case 'free_visit':
                    return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ';
                default:
                    return '–ë–æ–Ω—É—Å';
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // –†–µ–∞–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞
        async function scanQRCode() {
            if (!currentUser) {
                showError('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–∫–∞–Ω–µ—Ä Telegram
                if (tg.showScanQrPopup) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫–∞–Ω–µ—Ä Telegram
                    tg.showScanQrPopup({
                        text: '–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –∑–∞–≤–µ–¥–µ–Ω–∏—è'
                    }, async (qrData) => {
                        tg.closeScanQrPopup();
                        
                        if (qrData) {
                            console.log('QR Code scanned:', qrData);
                            await markVisit(qrData);
                        } else {
                            console.log('QR scan cancelled');
                        }
                    });
                } else {
                    // Fallback: —Å–∏–º—É–ª—è—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    console.log('Telegram QR scanner not available, using simulation');
                    const qrData = 'HOOKAH_PLACE_QR';
                    await markVisit(qrData);
                }
            } catch (error) {
                console.error('Error opening QR scanner:', error);
                // Fallback: —Å–∏–º—É–ª—è—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                console.log('Falling back to simulation');
                const qrData = 'HOOKAH_PLACE_QR';
                await markVisit(qrData);
            }
        }

        // –û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è
        async function markVisit(qrData) {
            try {
                const response = await fetch('/api/visit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        qr_code: qrData
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }

                const result = await response.json();
                
                showSuccess('–ü–æ—Å–µ—â–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await loadUserData();
                await loadVisitHistory();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–æ–Ω—É—Å–µ
                if (result.bonus_earned) {
                    showBonusNotification();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è:', error);
                showError(error.message);
            }
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±–æ–Ω—É—Å–µ
        function showBonusNotification() {
            const bonusInfo = document.getElementById('bonusInfo');
            bonusInfo.style.display = 'block';
            bonusInfo.innerHTML = '<div class="bonus-text">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å!</div>';
            
            setTimeout(() => {
                bonusInfo.style.display = 'none';
            }, 5000);
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // –ü–æ–∫–∞–∑ —É—Å–ø–µ—Ö–∞
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('scanButton').addEventListener('click', scanQRCode);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>