<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HookahPlace Bonus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="preload" href="/fonts/bebasneuecyrillic.ttf" as="font" type="font/ttf" crossorigin>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @font-face {
            font-family: 'Bebas Neue Cyrillic';
            src: url('/fonts/bebasneuecyrillic.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Bebas Neue Cyrillic';
            src: url('/fonts/bebasneuecyrillic.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-ThinItalic.ttf') format('truetype');
            font-weight: 100;
            font-style: italic;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-ExtraLight.ttf') format('truetype');
            font-weight: 200;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-ExtraLightItalic.ttf') format('truetype');
            font-weight: 200;
            font-style: italic;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-LightItalic.ttf') format('truetype');
            font-weight: 300;
            font-style: italic;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-Italic.ttf') format('truetype');
            font-weight: 400;
            font-style: italic;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-MediumItalic.ttf') format('truetype');
            font-weight: 500;
            font-style: italic;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-SemiBoldItalic.ttf') format('truetype');
            font-weight: 600;
            font-style: italic;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-BoldItalic.ttf') format('truetype');
            font-weight: 700;
            font-style: italic;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-ExtraBold.ttf') format('truetype');
            font-weight: 800;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-ExtraBoldItalic.ttf') format('truetype');
            font-weight: 800;
            font-style: italic;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto Condensed';
            src: url('/fonts/RobotoCondensed-BlackItalic.ttf') format('truetype');
            font-weight: 900;
            font-style: italic;
        }
        
        :root {
            --hp-accent: var(--tg-theme-button-color, #9146FF);
            --hp-accent-text: var(--tg-theme-button-text-color, #ffffff);
            --hp-bg: var(--tg-theme-bg-color, #0f0f10);
            --hp-text: var(--tg-theme-text-color, #ffffff);
            --hp-muted: var(--tg-theme-hint-color, #8b8b8b);
            --hp-surface: var(--tg-theme-secondary-bg-color, #17181a);
            --hp-surface-2: rgba(255,255,255,0.06);
            --hp-border: rgba(255,255,255,0.08);
            --hp-radius: 16px;
            --hp-radius-sm: 12px;
            --hp-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            color: var(--hp-text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 440px;
            margin: 0 auto;
            padding: 20px 20px 20px;
        }

        .header {
            position: relative;
            text-align: center;
            margin-bottom: 44px;
            padding: 24px 0 8px;
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            border: 1px solid var(--hp-border);
            backdrop-filter: blur(10px);
        }

        .brand-emoji {
            font-size: 20px;
        }

        .brand-name {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 0;
            text-transform: uppercase;
        }

        .subtitle {
            margin-top: 10px;
            color: var(--hp-muted);
            font-size: 13px;
        }

        .user-info {
            position: relative;
            margin-bottom: 44px;
        }

        .user-name {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 0;
            margin-bottom: 12px;
            color: #ffffff;
            text-transform: uppercase;
        }

        .contacts > div:not(.user-name) {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            color: #ffffff;
        }

        #progressText {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .stat-item {
            text-align: center;
            background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border: 1px solid var(--hp-border);
            border-radius: var(--hp-radius-sm);
            padding: 12px 8px;
        }

        .stat-number {
            font-size: 22px;
            font-weight: 800;
            color: var(--hp-accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--hp-muted);
            margin-top: 2px;
        }

        .progress-bar {
            position: relative;
            background: #2F2F2F;
            border: none;
            border-radius: 999px;
            height: 6px;
            margin: 8px 0 6px;
            overflow: hidden;
        }

        .progress-fill {
            background: #FF0000;
            height: 100%;
            border-radius: 999px;
            transition: width 0.3s ease;
        }

        .bonus-info {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: #ffffff;
            border-radius: var(--hp-radius);
            padding: 14px;
            text-align: center;
            margin-bottom: 24px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--hp-shadow);
        }

        .bonus-text {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 0;
            text-transform: uppercase;
        }

        .scan-button {
            width: 100%;
            margin-top: 20px;
            background: transparent;
            color: #ffffff;
            border: 1px solid #ffffff;
            border-radius: 0;
            padding: 16px;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 16px;
            font-weight: 600;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.08s ease, opacity 0.2s ease;
        }

        .scan-button:hover { opacity: 0.95; }
        .scan-button:active { transform: translateY(1px); }

        .scan-button:disabled { opacity: 0.45; cursor: not-allowed; }

        .history-section {
            margin-top: 24px;
        }

        .section-title {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 20px;
            font-weight: 800;
            letter-spacing: 0;
            margin-bottom: 12px;
            color: #ffffff;
            text-transform: uppercase;
        }

        .visit-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #2F2F2F;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #ffffff;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
        }
        
        .visit-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .visit-date {
            font-size: 14px;
            color: var(--hp-muted);
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 400;
            text-transform: uppercase;
        }

        .bonus-item {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: #ffffff;
            border-radius: var(--hp-radius-sm);
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--hp-shadow);
        }

        .bonus-type { font-weight: 700; }

        .bonus-status { font-size: 12px; opacity: 0.8; }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--hp-muted);
        }

        .error {
            background: #ff6b6b;
            color: #ffffff;
            padding: 12px;
            border-radius: var(--hp-radius-sm);
            margin-bottom: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--hp-shadow);
        }

        .success {
            background: #4ecdc4;
            color: #ffffff;
            padding: 12px;
            border-radius: var(--hp-radius-sm);
            margin-bottom: 16px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: var(--hp-shadow);
        }
        
        .staff-section {
            margin-top: 24px;
            margin-bottom: 24px;
        }
        
        .staff-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }
        
        .staff-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .staff-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 2px solid var(--hp-border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: 700;
            font-size: 20px;
            overflow: hidden;
        }
        
        .staff-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .staff-name {
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 12px;
            font-weight: 400;
            color: #ffffff;
            text-align: center;
            text-transform: uppercase;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-wrap" style="display:flex;align-items:center;justify-content:center;">
                <div style="width:100%;">
<svg width="352" height="49" viewBox="0 0 352 49" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:block;width:100%;height:auto;">
<path d="M10.5743 47.962H3.12252V0.54193H10.5743V20.8648H19.0421V0.54193H26.6293V47.962H19.0421V27.6391H10.5743V47.962ZM38.8744 37.0554C38.8744 38.7716 39.2131 39.9909 39.8906 40.7135C40.6132 41.391 41.5616 41.7297 42.7358 41.7297C43.91 41.7297 44.8358 41.391 45.5132 40.7135C46.2358 39.9909 46.5971 38.7716 46.5971 37.0554V11.4486C46.5971 9.7324 46.2358 8.53561 45.5132 7.85818C44.8358 7.13558 43.91 6.77429 42.7358 6.77429C41.5616 6.77429 40.6132 7.13558 39.8906 7.85818C39.2131 8.53561 38.8744 9.7324 38.8744 11.4486V37.0554ZM31.4227 11.9228C31.4227 8.08399 32.3937 5.14845 34.3356 3.11616C36.2776 1.03871 39.0777 -1.08803e-05 42.7358 -1.08803e-05C46.3939 -1.08803e-05 49.1939 1.03871 51.1359 3.11616C53.0779 5.14845 54.0489 8.08399 54.0489 11.9228V36.5812C54.0489 40.42 53.0779 43.3781 51.1359 45.4555C49.1939 47.4878 46.3939 48.504 42.7358 48.504C39.0777 48.504 36.2776 47.4878 34.3356 45.4555C32.3937 43.3781 31.4227 40.42 31.4227 36.5812V11.9228ZM65.7335 37.0554C65.7335 38.7716 66.0722 39.9909 66.7496 40.7135C67.4722 41.391 68.4206 41.7297 69.5948 41.7297C70.769 41.7297 71.6949 41.391 72.3723 40.7135C73.0949 39.9909 73.4562 38.7716 73.4562 37.0554V11.4486C73.4562 9.7324 73.0949 8.53561 72.3723 7.85818C71.6949 7.13558 70.769 6.77429 69.5948 6.77429C68.4206 6.77429 67.4722 7.13558 66.7496 7.85818C66.0722 8.53561 65.7335 9.7324 65.7335 11.4486V37.0554ZM58.2817 11.9228C58.2817 8.08399 59.2527 5.14845 61.1947 3.11616C63.1367 1.03871 65.9367 -1.08803e-05 69.5948 -1.08803e-05C73.2529 -1.08803e-05 76.053 1.03871 77.995 3.11616C79.9369 5.14845 80.9079 8.08399 80.9079 11.9228V36.5812C80.9079 40.42 79.9369 43.3781 77.995 45.4555C76.053 47.4878 73.2529 48.504 69.5948 48.504C65.9367 48.504 63.1367 47.4878 61.1947 45.4555C59.2527 43.3781 58.2817 40.42 58.2817 36.5812V11.9228ZM95.5055 29.0617L93.2022 33.3973V47.962H85.7505V0.54193H93.2022V21.2035L103.093 0.54193H110.409L100.044 21.6777L110.409 47.962H102.754L95.5055 29.0617ZM137.917 47.962H130.397L129.11 39.3587H119.965L118.678 47.962H111.836L119.423 0.54193H130.33L137.917 47.962ZM120.913 32.9231H128.094L124.504 8.94206L120.913 32.9231ZM148.839 47.962H141.387V0.54193H148.839V20.8648H157.307V0.54193H164.894V47.962H157.307V27.6391H148.839V47.962Z" fill="white"/>
<path d="M219.649 18.657C219.649 18.657 213.827 22.3887 213.827 24.4236C213.827 26.4714 219.649 30.1993 219.649 30.1993C217.496 38.9647 210.6 45.8904 201.79 48.1211C201.79 48.1211 198.052 42.424 196.031 42.424C193.944 42.424 190.124 48.2636 190.124 48.2636C181.028 46.2105 173.851 39.1695 171.662 30.1993C171.662 30.1993 177.486 26.4714 177.486 24.4236C177.486 22.3887 171.662 18.657 171.662 18.657C173.826 9.78575 180.873 2.80508 189.838 0.6604C189.838 0.6604 193.587 6.42888 195.645 6.42888C197.71 6.42888 201.488 0.6604 201.488 0.6604C210.426 2.80324 217.487 9.78575 219.649 18.657Z" fill="#FF0000"/>
<path d="M237.354 0.54193C241.102 0.54193 243.88 1.53549 245.686 3.52262C247.538 5.50975 248.464 8.4227 248.464 12.2615V18.4261C248.464 22.2649 247.538 25.1778 245.686 27.1649C243.88 29.1521 241.102 30.1456 237.354 30.1456H233.831V47.962H226.379V0.54193H237.354ZM233.831 7.31623V23.3713H237.354C238.528 23.3713 239.431 23.0552 240.063 22.4229C240.696 21.7907 241.012 20.6164 241.012 18.9003V11.7873C241.012 10.0711 240.696 8.8969 240.063 8.26463C239.431 7.63237 238.528 7.31623 237.354 7.31623H233.831ZM251.915 0.54193H259.367V41.1877H271.629V47.962H251.915V0.54193ZM299.12 47.962H291.601L290.313 39.3587H281.168L279.881 47.962H273.039L280.626 0.54193H291.533L299.12 47.962ZM282.117 32.9231H289.297L285.707 8.94206L282.117 32.9231ZM324.2 30.2811V36.5812C324.2 40.42 323.252 43.3781 321.355 45.4555C319.503 47.4878 316.749 48.504 313.09 48.504C309.432 48.504 306.655 47.4878 304.758 45.4555C302.906 43.3781 301.981 40.42 301.981 36.5812V11.9228C301.981 8.08399 302.906 5.14845 304.758 3.11616C306.655 1.03871 309.432 -1.08803e-05 313.09 -1.08803e-05C316.749 -1.08803e-05 319.503 1.03871 321.355 3.11616C323.252 5.14845 324.2 8.08399 324.2 11.9228V16.5293H317.155V11.4486C317.155 9.7324 316.794 8.53561 316.071 7.85818C315.394 7.13558 314.468 6.77429 313.294 6.77429C312.119 6.77429 311.171 7.13558 310.448 7.85818C309.771 8.53561 309.432 9.7324 309.432 11.4486V37.0554C309.432 38.7716 309.771 39.9684 310.448 40.6458C311.171 41.3232 312.119 41.6619 313.294 41.6619C314.468 41.6619 315.394 41.3232 316.071 40.6458C316.794 39.9684 317.155 38.7716 317.155 37.0554V30.2811H324.2ZM336.173 20.5261H346.403V27.3004H336.173V41.1877H349.044V47.962H328.722V0.54193H349.044V7.31623H336.173V20.5261Z" fill="white"/>
</svg>
                </div>
            </div>
        </div>

        <div class="user-info" id="userInfo">
            <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div id="progressText" style="text-align: left; font-size: 14px; color: var(--tg-theme-hint-color, #999999);">
                –î–æ –±–æ–Ω—É—Å–∞ 10 –ø–æ—Å–µ—â–µ–Ω–∏–π
            </div>
            <button id="scanButton" class="scan-button">—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å qr-–∫–æ–¥</button>
        </div>

        <div class="user-info contacts">
            <div class="user-name">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
            <div style="margin-bottom: 8px;">–≥. –ß–∏—Ç–∞, —É–ª. –°—Ç–æ–ª—è—Ä–æ–≤–∞, 19</div>
            <div style="margin-bottom: 8px;">+7 924 818 00 88</div>
            <div>–ï–∂–µ–¥–Ω–µ–≤–Ω–æ 16:00 ‚Äî 03:00</div>
        </div>

        <div id="bonusInfo" class="bonus-info" style="display: none;">
            <div class="bonus-text">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å!</div>
        </div>

        <div class="staff-section">
            <div class="section-title">–°–µ–≥–æ–¥–Ω—è –Ω–∞ —Å–º–µ–Ω–µ</div>
            <div id="staffOnShift" class="staff-grid">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <div class="history-section">
            <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π</div>
            <div id="visitHistory"></div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è '–ú–æ–∏ –±–æ–Ω—É—Å—ã' —É–¥–∞–ª–µ–Ω–∞ -->
    </div>

    <script>
        // Telegram WebApp API
        const tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
            console.log('Telegram WebApp initialized');
        } else {
            console.warn('Telegram WebApp not available - running in demo mode');
        }

        let currentUser = null;
        let visitHistory = [];
        let bonusHistory = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            try {
                console.log('Initializing app...');
                console.log('Telegram WebApp available:', !!window.Telegram?.WebApp);
                console.log('Telegram initDataUnsafe:', tg.initDataUnsafe);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                const telegramUser = tg.initDataUnsafe?.user;
                console.log('Telegram user data:', telegramUser);
                
                if (telegramUser) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                    console.log('Using real Telegram user:', telegramUser);
                    await createUser(telegramUser);
                } else {
                    // Fallback: —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    console.log('No Telegram user data, creating demo user');
                    const demoUser = {
                        id: Math.floor(Math.random() * 1000000) + 100000,
                        username: 'demo_user',
                        first_name: 'Demo',
                        last_name: 'User'
                    };
                    await createUser(demoUser);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
                if (!currentUser || !currentUser.id) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
                
                console.log('User created successfully, loading data...');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserData();
                await loadVisitHistory();
                await loadStaffOnShift();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function createUser(telegramUser) {
            console.log('Creating user:', telegramUser);
            try {
                const userData = {
                    telegram_id: parseInt(telegramUser.id),
                    username: String(telegramUser.username || 'demo_user'),
                    first_name: String(telegramUser.first_name || 'Demo'),
                    last_name: String(telegramUser.last_name || 'User')
                };
                
                console.log('Sending user data:', userData);
                console.log('API endpoint:', '/api/user');
                
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    console.error('Response status:', response.status);
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + errorText);
                }

                const result = await response.json();
                console.log('User creation result:', result);
                
                if (!result.user_id) {
                    console.error('No user_id in result:', result);
                    throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω user_id –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentUser —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
                currentUser = { 
                    id: result.user_id,
                    telegram_id: userData.telegram_id,
                    username: userData.username,
                    first_name: userData.first_name,
                    last_name: userData.last_name
                };
                
                console.log('User created successfully:', currentUser);
                console.log('currentUser.id:', currentUser.id);
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                if (!currentUser || !currentUser.id) {
                    console.error('currentUser validation failed:', currentUser);
                    throw new Error('currentUser –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
                }
                
                return currentUser;
                
            } catch (error) {
                console.error('Error creating user:', error);
                console.error('Error stack:', error.stack);
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            if (!currentUser || !currentUser.id) {
                console.error('currentUser is null or has no id:', currentUser);
                throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
            }
            
            console.log('Loading user data for user ID:', currentUser.id);
            
            try {
                const response = await fetch(`/api/user/${currentUser.id}`);
                console.log('User data API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('User data API error:', errorText);
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ –∑–∞–Ω–æ–≤–æ
                    if (response.status === 404) {
                        console.log('User not found, attempting to recreate...');
                        throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                    }
                    
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + errorText);
                }

                const data = await response.json();
                console.log('User data API response:', data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º currentUser —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
                currentUser = { ...currentUser, ...data.user };
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                const userName = `${data.user.first_name} ${data.user.last_name || ''}`.trim() || 
                               data.user.username || 
                               '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('userName').textContent = userName;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
                const progress = ((data.visits % 10) / 10) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = 
                    `–î–æ –±–æ–Ω—É—Å–∞ ${data.visits_to_bonus} –ø–æ—Å–µ—â–µ–Ω–∏–π`;
                    
                console.log('User data loaded successfully:', {
                    name: userName,
                    visits: data.visits,
                    bonuses: data.bonuses
                });
            } catch (error) {
                console.error('Error loading user data:', error);
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
        async function loadVisitHistory() {
            if (!currentUser) {
                console.error('currentUser is null');
                return;
            }
            
            const response = await fetch(`/api/visits/${currentUser.id}`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π');
            }

            visitHistory = await response.json();
            renderVisitHistory();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤
        // async function loadBonusHistory() {
        //     if (!currentUser) {
        //         console.error('currentUser is null');
        //         return;
        //     }
            
        //     const response = await fetch(`/api/bonuses/${currentUser.id}`);
        //     if (!response.ok) {
        //         throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤');
        //     }

        //     bonusHistory = await response.json();
        //     renderBonusHistory();
        // }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
        function renderVisitHistory() {
            const container = document.getElementById('visitHistory');
            container.innerHTML = '';

            if (visitHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--tg-theme-hint-color, #999999); padding: 20px;">–ù–µ—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π</div>';
                return;
            }

            visitHistory.forEach(visit => {
                const visitElement = document.createElement('div');
                visitElement.className = 'visit-item';
                visitElement.innerHTML = `
                    <div>${formatDate(visit.visit_date)}</div>
                    <div class="visit-date">${formatTime(visit.visit_date)}</div>
                `;
                container.appendChild(visitElement);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤
        // function renderBonusHistory() {
        //     const container = document.getElementById('bonusHistory');
        //     container.innerHTML = '';

        //     if (bonusHistory.length === 0) {
        //         container.innerHTML = '<div style="text-align: center; color: var(--tg-theme-hint-color, #999999); padding: 20px;">–ù–µ—Ç –±–æ–Ω—É—Å–æ–≤</div>';
        //         return;
        //     }

        //     bonusHistory.forEach(bonus => {
        //         const bonusElement = document.createElement('div');
        //         bonusElement.className = 'bonus-item';
        //         bonusElement.innerHTML = `
        //             <div>
        //                 <div class="bonus-type">${getBonusTypeText(bonus.bonus_type)}</div>
        //                 <div class="bonus-status">${formatDate(bonus.earned_date)}</div>
        //             </div>
        //             <div>
        //                 ${bonus.is_used ? '‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : '‚è≥ –î–æ—Å—Ç—É–ø–µ–Ω'}
        //             </div>
        //         `;
        //         container.appendChild(bonusElement);
        //     });
        // }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ç–∏–ø–∞ –±–æ–Ω—É—Å–∞
        function getBonusTypeText(type) {
            switch (type) {
                case 'free_visit':
                    return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ';
                default:
                    return '–ë–æ–Ω—É—Å';
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        // –†–µ–∞–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞
        async function scanQRCode() {
            console.log('scanQRCode called, currentUser:', currentUser);
            
            if (!currentUser || !currentUser.id) {
                console.error('currentUser is not defined or has no id:', currentUser);
                showError('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–∫–∞–Ω–µ—Ä Telegram
                if (tg && tg.showScanQrPopup) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫–∞–Ω–µ—Ä Telegram
                    console.log('Using Telegram QR scanner');
                    tg.showScanQrPopup({
                        text: '–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –∑–∞–≤–µ–¥–µ–Ω–∏—è'
                    }, async (qrData) => {
                        tg.closeScanQrPopup();
                        
                        if (qrData) {
                            console.log('QR Code scanned:', qrData);
                            await markVisit(qrData);
                        } else {
                            console.log('QR scan cancelled');
                        }
                    });
                } else {
                    // Fallback: —Å–∏–º—É–ª—è—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    console.log('Telegram QR scanner not available, using simulation');
                    const qrData = 'HOOKAH_PLACE_QR';
                    await markVisit(qrData);
                }
            } catch (error) {
                console.error('Error opening QR scanner:', error);
                // Fallback: —Å–∏–º—É–ª—è—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                console.log('Falling back to simulation');
                const qrData = 'HOOKAH_PLACE_QR';
                await markVisit(qrData);
            }
        }

        // –û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è
        async function markVisit(qrData) {
            try {
                console.log('Marking visit for user:', currentUser.id, 'with QR:', qrData);
                
                const response = await fetch('/api/visit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        qr_code: qrData
                    })
                });

                console.log('Visit API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Visit API error response:', errorText);
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è "—É–∂–µ –æ—Ç–º–µ—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è"
                    if (errorText.includes('—É–∂–µ –æ—Ç–º–µ—Ç–∏–ª–∏ –ø–æ—Å–µ—â–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è')) {
                        showError('–í—ã —É–∂–µ –æ—Ç–º–µ—Ç–∏–ª–∏ –ø–æ—Å–µ—â–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞ –¥–ª—è –Ω–æ–≤–æ–π –æ—Ç–º–µ—Ç–∫–∏ üòä');
                        return;
                    }
                    
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è: ' + errorText);
                }

                const result = await response.json();
                console.log('Visit API result:', result);
                
                showSuccess('üéâ –ü–æ—Å–µ—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ—á–µ–Ω–æ!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await loadUserData();
                await loadVisitHistory();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–æ–Ω—É—Å–µ
                if (result.bonus_earned) {
                    showBonusNotification();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è:', error);
                showError(error.message);
            }
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±–æ–Ω—É—Å–µ
        function showBonusNotification() {
            const bonusInfo = document.getElementById('bonusInfo');
            bonusInfo.style.display = 'block';
            bonusInfo.innerHTML = '<div class="bonus-text">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å –∑–∞ 10 –ø–æ—Å–µ—â–µ–Ω–∏–π!</div>';
            
            setTimeout(() => {
                bonusInfo.style.display = 'none';
            }, 5000);
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // –ü–æ–∫–∞–∑ —É—Å–ø–µ—Ö–∞
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ —Å–º–µ–Ω–µ
        async function loadStaffOnShift() {
            const staffDiv = document.getElementById('staffOnShift');
            
            try {
                const response = await fetch('/api/staff/on-shift');
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤');
                }
                
                const staff = await response.json();
                console.log('Staff on shift loaded:', staff);
                
                if (staff.length === 0) {
                    staffDiv.innerHTML = '<div style="text-align: center; color: var(--hp-muted); padding: 20px;">–°–µ–≥–æ–¥–Ω—è –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç –Ω–∞ —Å–º–µ–Ω–µ</div>';
                    return;
                }
                
                let html = '';
                
                staff.forEach(member => {
                    console.log(`Staff member: ${member.name}, avatar_url: ${member.avatar_url ? member.avatar_url.substring(0, 50) + '...' : 'null'}`);
                    const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                    let avatarHtml = initials;
                    
                    if (member.avatar_url) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ data URL –∏–ª–∏ –æ–±—ã—á–Ω—ã–π URL
                        const isDataUrl = member.avatar_url.startsWith('data:');
                        const isUrl = member.avatar_url.startsWith('http://') || member.avatar_url.startsWith('https://') || member.avatar_url.startsWith('/');
                        
                        if (isDataUrl || isUrl) {
                            avatarHtml = `<img src="${member.avatar_url}" alt="${member.name}" onerror="console.error('Avatar load error for ${member.name}'); this.parentElement.textContent='${initials}'" onload="console.log('Avatar loaded for ${member.name}')" style="display: block;">`;
                        } else {
                            console.warn(`Invalid avatar_url format for ${member.name}: ${member.avatar_url.substring(0, 50)}`);
                        }
                    }
                    
                    html += `
                        <div class="staff-item">
                            <div class="staff-avatar">
                                ${avatarHtml}
                            </div>
                            <div class="staff-name">${member.name}</div>
                        </div>
                    `;
                });
                
                staffDiv.innerHTML = html;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', error);
                staffDiv.innerHTML = '<div style="text-align: center; color: var(--hp-muted); padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('scanButton').addEventListener('click', scanQRCode);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>