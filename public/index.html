<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HookahPlace Bonus</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
            margin-bottom: 10px;
        }

        .user-info {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 4px;
        }

        .progress-bar {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--tg-theme-button-color, #2481cc);
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .bonus-info {
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            color: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .bonus-text {
            font-size: 16px;
            font-weight: 600;
        }

        .scan-button {
            width: 100%;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: opacity 0.2s;
        }

        .scan-button:hover {
            opacity: 0.9;
        }

        .scan-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .history-section {
            margin-top: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .visit-item {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .visit-date {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .bonus-item {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bonus-type {
            font-weight: 600;
        }

        .bonus-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: #4ecdc4;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üö¨ HookahPlace</div>
            <div>–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏</div>
        </div>

        <div id="userInfo" class="user-info">
            <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="visitCount">0</div>
                    <div class="stat-label">–ü–æ—Å–µ—â–µ–Ω–∏–π</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="bonusCount">0</div>
                    <div class="stat-label">–ë–æ–Ω—É—Å–æ–≤</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div id="progressText" style="text-align: center; font-size: 14px; color: var(--tg-theme-hint-color, #999999);">
                –î–æ –±–æ–Ω—É—Å–∞: 10 –ø–æ—Å–µ—â–µ–Ω–∏–π
            </div>
        </div>

        <div id="bonusInfo" class="bonus-info" style="display: none;">
            <div class="bonus-text">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å!</div>
        </div>

        <button id="scanButton" class="scan-button">
            üì± –û—Ç–º–µ—Ç–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏–µ
        </button>

        <div class="history-section">
            <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–µ—â–µ–Ω–∏–π</div>
            <div id="visitHistory"></div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è '–ú–æ–∏ –±–æ–Ω—É—Å—ã' —É–¥–∞–ª–µ–Ω–∞ -->
    </div>

    <script>
        // Telegram WebApp API
        const tg = window.Telegram?.WebApp;
        
        if (tg) {
            tg.ready();
            tg.expand();
            console.log('Telegram WebApp initialized');
        } else {
            console.warn('Telegram WebApp not available - running in demo mode');
        }

        let currentUser = null;
        let visitHistory = [];
        let bonusHistory = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            try {
                console.log('Initializing app...');
                console.log('Telegram WebApp available:', !!window.Telegram?.WebApp);
                console.log('Telegram initDataUnsafe:', tg.initDataUnsafe);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                const telegramUser = tg.initDataUnsafe?.user;
                console.log('Telegram user data:', telegramUser);
                
                if (telegramUser) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                    console.log('Using real Telegram user:', telegramUser);
                    await createUser(telegramUser);
                } else {
                    // Fallback: —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    console.log('No Telegram user data, creating demo user');
                    const demoUser = {
                        id: Math.floor(Math.random() * 1000000) + 100000,
                        username: 'demo_user',
                        first_name: 'Demo',
                        last_name: 'User'
                    };
                    await createUser(demoUser);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
                if (!currentUser || !currentUser.id) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
                
                console.log('User created successfully, loading data...');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadUserData();
                await loadVisitHistory();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function createUser(telegramUser) {
            console.log('Creating user:', telegramUser);
            try {
                const userData = {
                    telegram_id: parseInt(telegramUser.id),
                    username: String(telegramUser.username || 'demo_user'),
                    first_name: String(telegramUser.first_name || 'Demo'),
                    last_name: String(telegramUser.last_name || 'User')
                };
                
                console.log('Sending user data:', userData);
                console.log('API endpoint:', '/api/user');
                
                const response = await fetch('/api/user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error Response:', errorText);
                    console.error('Response status:', response.status);
                    throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + errorText);
                }

                const result = await response.json();
                console.log('User creation result:', result);
                
                if (!result.user_id) {
                    console.error('No user_id in result:', result);
                    throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω user_id –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º currentUser —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
                currentUser = { 
                    id: result.user_id,
                    telegram_id: userData.telegram_id,
                    username: userData.username,
                    first_name: userData.first_name,
                    last_name: userData.last_name
                };
                
                console.log('User created successfully:', currentUser);
                console.log('currentUser.id:', currentUser.id);
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                if (!currentUser || !currentUser.id) {
                    console.error('currentUser validation failed:', currentUser);
                    throw new Error('currentUser –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ');
                }
                
                return currentUser;
                
            } catch (error) {
                console.error('Error creating user:', error);
                console.error('Error stack:', error.stack);
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserData() {
            if (!currentUser || !currentUser.id) {
                console.error('currentUser is null or has no id:', currentUser);
                throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
            }
            
            console.log('Loading user data for user ID:', currentUser.id);
            
            try {
                const response = await fetch(`/api/user/${currentUser.id}`);
                console.log('User data API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('User data API error:', errorText);
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ –∑–∞–Ω–æ–≤–æ
                    if (response.status === 404) {
                        console.log('User not found, attempting to recreate...');
                        throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                    }
                    
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + errorText);
                }

                const data = await response.json();
                console.log('User data API response:', data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º currentUser —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î
                currentUser = { ...currentUser, ...data.user };
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                const userName = `${data.user.first_name} ${data.user.last_name || ''}`.trim() || 
                               data.user.username || 
                               '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('userName').textContent = userName;
                
                document.getElementById('visitCount').textContent = data.visits;
                document.getElementById('bonusCount').textContent = data.bonuses;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
                const progress = ((data.visits % 10) / 10) * 100;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = 
                    `–î–æ –±–æ–Ω—É—Å–∞: ${data.visits_to_bonus} –ø–æ—Å–µ—â–µ–Ω–∏–π`;
                    
                console.log('User data loaded successfully:', {
                    name: userName,
                    visits: data.visits,
                    bonuses: data.bonuses
                });
            } catch (error) {
                console.error('Error loading user data:', error);
                throw error;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
        async function loadVisitHistory() {
            if (!currentUser) {
                console.error('currentUser is null');
                return;
            }
            
            const response = await fetch(`/api/visits/${currentUser.id}`);
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π');
            }

            visitHistory = await response.json();
            renderVisitHistory();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤
        // async function loadBonusHistory() {
        //     if (!currentUser) {
        //         console.error('currentUser is null');
        //         return;
        //     }
            
        //     const response = await fetch(`/api/bonuses/${currentUser.id}`);
        //     if (!response.ok) {
        //         throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤');
        //     }

        //     bonusHistory = await response.json();
        //     renderBonusHistory();
        // }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏–π
        function renderVisitHistory() {
            const container = document.getElementById('visitHistory');
            container.innerHTML = '';

            if (visitHistory.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--tg-theme-hint-color, #999999); padding: 20px;">–ù–µ—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π</div>';
                return;
            }

            visitHistory.forEach(visit => {
                const visitElement = document.createElement('div');
                visitElement.className = 'visit-item';
                visitElement.innerHTML = `
                    <div>–ü–æ—Å–µ—â–µ–Ω–∏–µ #${visit.id}</div>
                    <div class="visit-date">${formatDate(visit.visit_date)}</div>
                `;
                container.appendChild(visitElement);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–Ω—É—Å–æ–≤
        // function renderBonusHistory() {
        //     const container = document.getElementById('bonusHistory');
        //     container.innerHTML = '';

        //     if (bonusHistory.length === 0) {
        //         container.innerHTML = '<div style="text-align: center; color: var(--tg-theme-hint-color, #999999); padding: 20px;">–ù–µ—Ç –±–æ–Ω—É—Å–æ–≤</div>';
        //         return;
        //     }

        //     bonusHistory.forEach(bonus => {
        //         const bonusElement = document.createElement('div');
        //         bonusElement.className = 'bonus-item';
        //         bonusElement.innerHTML = `
        //             <div>
        //                 <div class="bonus-type">${getBonusTypeText(bonus.bonus_type)}</div>
        //                 <div class="bonus-status">${formatDate(bonus.earned_date)}</div>
        //             </div>
        //             <div>
        //                 ${bonus.is_used ? '‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' : '‚è≥ –î–æ—Å—Ç—É–ø–µ–Ω'}
        //             </div>
        //         `;
        //         container.appendChild(bonusElement);
        //     });
        // }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Ç–∏–ø–∞ –±–æ–Ω—É—Å–∞
        function getBonusTypeText(type) {
            switch (type) {
                case 'free_visit':
                    return '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ';
                default:
                    return '–ë–æ–Ω—É—Å';
            }
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // –†–µ–∞–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞
        async function scanQRCode() {
            console.log('scanQRCode called, currentUser:', currentUser);
            
            if (!currentUser || !currentUser.id) {
                console.error('currentUser is not defined or has no id:', currentUser);
                showError('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–∫–∞–Ω–µ—Ä Telegram
                if (tg && tg.showScanQrPopup) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫–∞–Ω–µ—Ä Telegram
                    console.log('Using Telegram QR scanner');
                    tg.showScanQrPopup({
                        text: '–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –∑–∞–≤–µ–¥–µ–Ω–∏—è'
                    }, async (qrData) => {
                        tg.closeScanQrPopup();
                        
                        if (qrData) {
                            console.log('QR Code scanned:', qrData);
                            await markVisit(qrData);
                        } else {
                            console.log('QR scan cancelled');
                        }
                    });
                } else {
                    // Fallback: —Å–∏–º—É–ª—è—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    console.log('Telegram QR scanner not available, using simulation');
                    const qrData = 'HOOKAH_PLACE_QR';
                    await markVisit(qrData);
                }
            } catch (error) {
                console.error('Error opening QR scanner:', error);
                // Fallback: —Å–∏–º—É–ª—è—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                console.log('Falling back to simulation');
                const qrData = 'HOOKAH_PLACE_QR';
                await markVisit(qrData);
            }
        }

        // –û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è
        async function markVisit(qrData) {
            try {
                console.log('Marking visit for user:', currentUser.id, 'with QR:', qrData);
                
                const response = await fetch('/api/visit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        qr_code: qrData
                    })
                });

                console.log('Visit API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Visit API error response:', errorText);
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è "—É–∂–µ –æ—Ç–º–µ—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è"
                    if (errorText.includes('—É–∂–µ –æ—Ç–º–µ—Ç–∏–ª–∏ –ø–æ—Å–µ—â–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è')) {
                        showError('–í—ã —É–∂–µ –æ—Ç–º–µ—Ç–∏–ª–∏ –ø–æ—Å–µ—â–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è! –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞–≤—Ç—Ä–∞ –¥–ª—è –Ω–æ–≤–æ–π –æ—Ç–º–µ—Ç–∫–∏ üòä');
                        return;
                    }
                    
                    throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è: ' + errorText);
                }

                const result = await response.json();
                console.log('Visit API result:', result);
                
                showSuccess('üéâ –ü–æ—Å–µ—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ—á–µ–Ω–æ!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await loadUserData();
                await loadVisitHistory();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–æ–Ω—É—Å–µ
                if (result.bonus_earned) {
                    showBonusNotification();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è:', error);
                showError(error.message);
            }
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±–æ–Ω—É—Å–µ
        function showBonusNotification() {
            const bonusInfo = document.getElementById('bonusInfo');
            bonusInfo.style.display = 'block';
            bonusInfo.innerHTML = '<div class="bonus-text">üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å –∑–∞ 10 –ø–æ—Å–µ—â–µ–Ω–∏–π!</div>';
            
            setTimeout(() => {
                bonusInfo.style.display = 'none';
            }, 5000);
        }

        // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // –ü–æ–∫–∞–∑ —É—Å–ø–µ—Ö–∞
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('scanButton').addEventListener('click', scanQRCode);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>